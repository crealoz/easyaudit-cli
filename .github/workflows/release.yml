name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      packages: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: curl, json
          tools: box

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "MAJOR=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
          echo "MINOR=$(echo $VERSION | cut -d. -f1,2)" >> $GITHUB_OUTPUT

      - name: Inject version into source
        run: |
          sed -i "s/VERSION = 'dev'/VERSION = '${{ steps.version.outputs.VERSION }}'/" src/Version.php

      - name: Build PHAR (first pass)
        run: box compile

      - name: Calculate PHAR hash
        id: hash
        run: |
          HASH=$(sha512sum easyaudit.phar | cut -d' ' -f1)
          echo "HASH=$HASH" >> $GITHUB_OUTPUT

      - name: Inject hash into source
        run: |
          sed -i "s/HASH = 'dev'/HASH = '${{ steps.hash.outputs.HASH }}'/" src/Version.php

      - name: Build PHAR (final)
        run: box compile

      - name: Verify PHAR
        run: |
          php easyaudit.phar --version
          echo "PHAR size: $(du -h easyaudit.phar | cut -f1)"
      - name: Check middleware readiness
        if: ${{ vars.DEPLOY_WEBHOOK_URL != '' }}
        run: |
          PAYLOAD='{"action":"status","version":"${{ steps.version.outputs.VERSION }}"}'
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha512 -hmac "${{ secrets.DEPLOY_SECRET }}" | cut -d' ' -f2)

          RESPONSE=$(curl -s -X POST "${{ vars.DEPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Deploy-Signature: sha512=$SIGNATURE" \
            -d "$PAYLOAD" \
            --max-time 30)

          STATUS=$(echo "$RESPONSE" | jq -r '.status')

          if [ "$STATUS" != "ready" ]; then
            echo "::error::Middleware v${{ steps.version.outputs.VERSION }} not deployed. Deploy middleware first."
            exit 1
          fi

      - name: Switch middleware to new version
        if: ${{ vars.DEPLOY_WEBHOOK_URL != '' }}
        run: |
          PAYLOAD='{"action":"switch","version":"${{ steps.version.outputs.VERSION }}"}'
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha512 -hmac "${{ secrets.DEPLOY_SECRET }}" | cut -d' ' -f2)

          HTTP_CODE=$(curl -s -o /tmp/switch.json -w "%{http_code}" \
            -X POST "${{ vars.DEPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-Deploy-Signature: sha512=$SIGNATURE" \
            -d "$PAYLOAD" \
            --max-time 60)

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to switch middleware to v${{ steps.version.outputs.VERSION }}"
            cat /tmp/switch.json
            exit 1
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: easyaudit.phar
          generate_release_notes: true
          fail_on_unmatched_files: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/easyaudit
          VERSION=${{ steps.version.outputs.VERSION }}
          MINOR=${{ steps.version.outputs.MINOR }}
          MAJOR=${{ steps.version.outputs.MAJOR }}

          docker build -t $IMAGE:$VERSION .

          # Mobile tags
          docker tag $IMAGE:$VERSION $IMAGE:$MINOR
          docker tag $IMAGE:$VERSION $IMAGE:$MAJOR
          docker tag $IMAGE:$VERSION $IMAGE:latest

          docker push $IMAGE:$VERSION
          docker push $IMAGE:$MINOR
          docker push $IMAGE:$MAJOR
          docker push $IMAGE:latest
