#!/usr/bin/env php
<?php
if (version_compare(PHP_VERSION, '8.1', '<')) {
    fwrite(STDERR, "EasyAudit requires PHP >= 8.1\n");
    exit(64);
}
define('RESET', "\033[0m");
define('GREEN', "\033[32m");
define('RED', "\033[31m");
define('YELLOW', "\033[33m");
define('BLUE', "\033[34m");
define('BOLD', "\033[1m");

set_exception_handler(function (Throwable $e) {
    fwrite(STDERR, RED . "Error: " . $e->getMessage() . RESET . "\n");
    exit($e->getCode() ?: 1);
});

set_error_handler(function ($severity, $message, $file, $line) {
    if (!(error_reporting() & $severity)) {
        return;
    }
    throw new ErrorException($message, 0, $severity, $file, $line);
});

spl_autoload_register(function ($class) {
    $prefix = 'EasyAudit\\';
    $baseDir = __DIR__ . '/../src/';

    if (str_starts_with($class, $prefix)) {
        $relative = substr($class, strlen($prefix));
        $file = $baseDir . str_replace('\\', '/', $relative) . '.php';
        if (file_exists($file)) {
            require $file;
        }
    }
});

// Service creation
$scanner = new \EasyAudit\Core\Scan\Scanner();
$logger  = new \EasyAudit\Service\Logger();
$api     = new \EasyAudit\Service\Api();

// Command registry
$commands = [
    'scan'                 => fn() => new \EasyAudit\Console\Command\Scan($scanner),
    'auth'                 => fn() => new \EasyAudit\Console\Command\Auth(),
    'fix-apply'            => fn() => new \EasyAudit\Console\Command\FixApply($logger, $api),
    'activate-self-signed' => fn() => new \EasyAudit\Console\Command\ActivateSelfSigned(),
];

$cmdName = $argv[1] ?? null;

// Handle --version / -v at top level
if ($cmdName === '-v' || $cmdName === '--version') {
    fwrite(STDOUT, \EasyAudit\Version::getVersionString() . "\n");
    if (\EasyAudit\Version::isReleaseBuild()) {
        fwrite(STDOUT, "Full hash: " . \EasyAudit\Version::HASH . "\n");
    }
    exit(0);
}

// Handle -h or --help at top level
if ($cmdName === '-h' || $cmdName === '--help' || $cmdName === null) {
    fwrite(STDOUT, BOLD . "EasyAudit" . RESET . " - Static analysis tool for Magento 2 codebases\n\n");
    fwrite(STDOUT, YELLOW . "Usage:" . RESET . " easyaudit <command> [options]\n\n");
    fwrite(STDOUT, YELLOW . "Commands:" . RESET . "\n");

    // Get descriptions from each command
    foreach ($commands as $name => $factory) {
        /** @var \EasyAudit\Console\CommandInterface $cmd */
        $cmd = $factory();
        $synopsis = $cmd->getSynopsis();
        $desc = $cmd->getDescription();
        fwrite(STDOUT, "  " . GREEN . str_pad($synopsis, 36) . RESET . " $desc\n");
    }

    fwrite(STDOUT, "\n" . YELLOW . "Global options:" . RESET . "\n");
    fwrite(STDOUT, "  " . GREEN . "-h, --help" . RESET . "                         Show help for a command\n");
    fwrite(STDOUT, "  " . GREEN . "-v, --version" . RESET . "                      Show version information\n");
    fwrite(STDOUT, "\n" . YELLOW . "Examples:" . RESET . "\n");
    fwrite(STDOUT, "  easyaudit scan /path/to/magento\n");
    fwrite(STDOUT, "  easyaudit scan -h\n");
    fwrite(STDOUT, "  easyaudit fix-apply report.json\n");
    exit(0);
}

if (!isset($commands[$cmdName])) {
    fwrite(STDERR, RED . "Unknown command: $cmdName" . RESET . "\n");
    fwrite(STDERR, "Run 'easyaudit --help' to see available commands.\n");
    exit(64);
}

$command = $commands[$cmdName]();
$exitCode = $command->run(array_slice($argv, 2));
exit($exitCode);
